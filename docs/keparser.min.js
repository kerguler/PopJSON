require=(function(){function e(n,r,o){function t(s,a){if(!r[s]){if(!n[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var d=new Error("Cannot find module '"+s+"'");throw d.code="MODULE_NOT_FOUND",d}var l=r[s]={exports:{}};n[s][0].call(l.exports,function(e){var r=n[s][1][e];return t(r||e)},l,l.exports,e,n,r,o)}return r[s].exports}for(var i="function"==typeof require&&require,s=0;s<o.length;s++)t(o[s]);return t}return e})()({1:[function(e,n,r){},{}],2:[function(e,n,r){typeof Object.create==='function'?(n.exports=function(e,n){e.super_=n;e.prototype=Object.create(n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}):(n.exports=function(e,n){e.super_=n;var r=function(){};r.prototype=n.prototype;e.prototype=new r;e.prototype.constructor=e})},{}],3:[function(e,n,r){var o=n.exports={},t,i;function s(){throw new Error('setTimeout has not been defined')}function a(){throw new Error('clearTimeout has not been defined')}!function(){try{typeof setTimeout==='function'?(t=setTimeout):(t=s)}catch(e){t=s};try{typeof clearTimeout==='function'?(i=clearTimeout):(i=a)}catch(e){i=a}}();function u(e){if(t===setTimeout){return setTimeout(e,0)}if((t===s||!t)&&setTimeout){t=setTimeout;return setTimeout(e,0)}try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}function d(e){if(i===clearTimeout){return clearTimeout(e)}if((i===a||!i)&&clearTimeout){i=clearTimeout;return clearTimeout(e)}try{return i(e)}catch(n){try{return i.call(null,e)}catch(n){return i.call(this,e)}}}var l=[],p=!1,c,m=-1;function f(){if(!p||!c){return}p=!1;c.length?(l=c.concat(l)):(m=-1);l.length&&h()}function h(){if(p){return}var e=u(f);p=!0;var n=l.length;while(n){c=l;l=[];while(++m<n)c&&c[m].run();m=-1;n=l.length}c=null;p=!1;d(e)}o.nextTick=function(e){var n=new Array(arguments.length-1);if(arguments.length>1){for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r]}l.push(new _(e,n));l.length===1&&!p&&u(h)};function _(e,n){this.fun=e;this.array=n}_.prototype.run=function(){this.fun.apply(null,this.array)};o.title='browser';o.browser=!0;o.env={};o.argv=[];o.version='';o.versions={};function g(){}o.on=g;o.addListener=g;o.once=g;o.off=g;o.removeListener=g;o.removeAllListeners=g;o.emit=g;o.prependListener=g;o.prependOnceListener=g;o.listeners=function(e){return[]};o.binding=function(e){throw new Error('process.binding is not supported')};o.cwd=function(){return'/'};o.chdir=function(e){throw new Error('process.chdir is not supported')};o.umask=function(){return 0}},{}],4:[function(e,n,r){n.exports=function(e){return e&&typeof e==='object'&&typeof e.copy==='function'&&typeof e.fill==='function'&&typeof e.readUInt8==='function'}},{}],5:[function(e,n,r){(function(n,o){var t=/%[sdj%]/g;r.format=function(e){if(!v(e)){var n=[];for(var r=0;r<arguments.length;r++)n.push(a(arguments[r]));return n.join(' ')}var r=1,o=arguments,i=o.length,s=String(e).replace(t,function(e){if(e==='%%')return'%';if(r>=i)return e;switch(e){case '%s':return String(o[r++]);case '%d':return Number(o[r++]);case '%j':try{return JSON.stringify(o[r++])}catch(e){return'[Circular]'};default:return e}});for(var u=o[r];r<i;u=o[++r])b(u)||!N(u)?(s+=' '+u):(s+=' '+a(u));return s};r.deprecate=function(e,t){if(w(o.process)){return function(){return r.deprecate(e,t).apply(this,arguments)}}if(n.noDeprecation===!0){return e}var i=!1;function s(){if(!i){if(n.throwDeprecation){throw new Error(t)}else n.traceDeprecation?console.trace(t):console.error(t);i=!0}return e.apply(this,arguments)}return s};var i={},s;r.debuglog=function(e){w(s)&&(s=n.env.NODE_DEBUG||'');e=e.toUpperCase();if(!i[e]){if(new RegExp('\\b'+e+'\\b','i').test(s)){var o=n.pid;i[e]=function(){var n=r.format.apply(r,arguments);console.error('%s %d: %s',e,o,n)}}else i[e]=function(){}}return i[e]};function a(e,n){var o={seen:[],stylize:d};arguments.length>=3&&(o.depth=arguments[2]);arguments.length>=4&&(o.colors=arguments[3]);j(n)?(o.showHidden=n):n&&r._extend(o,n);w(o.showHidden)&&(o.showHidden=!1);w(o.depth)&&(o.depth=2);w(o.colors)&&(o.colors=!1);w(o.customInspect)&&(o.customInspect=!0);o.colors&&(o.stylize=u);return p(o,e,o.depth)}r.inspect=a;a.colors={'bold':[1,22],'italic':[3,23],'underline':[4,24],'inverse':[7,27],'white':[37,39],'grey':[90,39],'black':[30,39],'blue':[34,39],'cyan':[36,39],'green':[32,39],'magenta':[35,39],'red':[31,39],'yellow':[33,39]};a.styles={'special':'cyan','number':'yellow','boolean':'yellow','undefined':'grey','null':'bold','string':'green','date':'magenta','regexp':'red'};function u(e,n){var r=a.styles[n];if(r){return'\u001b['+a.colors[r][0]+'m'+e+'\u001b['+a.colors[r][1]+'m'}else{return e}}function d(e,n){return e}function l(e){var n={};e.forEach(function(e,r){n[e]=!0});return n}function p(e,n,o){if(e.customInspect&&n&&S(n.inspect)&&n.inspect!==r.inspect&&!(n.constructor&&n.constructor.prototype===n)){var t=n.inspect(o,e);v(t)||(t=p(e,t,o));return t}var i=c(e,n);if(i){return i}var s=Object.keys(n),a=l(s);e.showHidden&&(s=Object.getOwnPropertyNames(n));if(C(n)&&(s.indexOf('message')>=0||s.indexOf('description')>=0)){return m(n)}if(s.length===0){if(S(n)){var u=n.name?': '+n.name:'';return e.stylize('[Function'+u+']','special')}if(A(n)){return e.stylize(RegExp.prototype.toString.call(n),'regexp')}if(O(n)){return e.stylize(Date.prototype.toString.call(n),'date')}if(C(n)){return m(n)}}var d='',j=!1,b=['{','}'];g(n)&&(j=!0,b=['[',']']);if(S(n)){var E=n.name?': '+n.name:'';d=' [Function'+E+']'}A(n)&&(d=' '+RegExp.prototype.toString.call(n));O(n)&&(d=' '+Date.prototype.toUTCString.call(n));C(n)&&(d=' '+m(n));if(s.length===0&&(!j||n.length==0)){return b[0]+d+b[1]}if(o<0){if(A(n)){return e.stylize(RegExp.prototype.toString.call(n),'regexp')}else{return e.stylize('[Object]','special')}}e.seen.push(n);var y;j?(y=f(e,n,o,a,s)):(y=s.map(function(r){return h(e,n,o,a,r,j)}));e.seen.pop();return _(y,d,b)}function c(e,n){if(w(n))return e.stylize('undefined','undefined');if(v(n)){var r='\''+JSON.stringify(n).replace(/^"|"$/g,'').replace(/'/g,"\\'").replace(/\\"/g,'"')+'\'';return e.stylize(r,'string')}if(y(n))return e.stylize(''+n,'number');if(j(n))return e.stylize(''+n,'boolean');if(b(n))return e.stylize('null','null')}function m(e){return'['+Error.prototype.toString.call(e)+']'}function f(e,n,r,o,t){var i=[];for(var s=0,a=n.length;s<a;++s)M(n,String(s))?i.push(h(e,n,r,o,String(s),!0)):i.push('');t.forEach(function(t){t.match(/^\d+$/)||i.push(h(e,n,r,o,t,!0))});return i}function h(e,n,r,o,t,i){var s,a,u;u=Object.getOwnPropertyDescriptor(n,t)||{value:n[t]};u.get?(u.set?(a=e.stylize('[Getter/Setter]','special')):(a=e.stylize('[Getter]','special'))):(u.set&&(a=e.stylize('[Setter]','special')));M(o,t)||(s='['+t+']');a||(e.seen.indexOf(u.value)<0?(b(r)?(a=p(e,u.value,null)):(a=p(e,u.value,r-1)),a.indexOf('\n')>-1&&(i?(a=a.split('\n').map(function(e){return'  '+e}).join('\n').substr(2)):(a='\n'+a.split('\n').map(function(e){return'   '+e}).join('\n')))):(a=e.stylize('[Circular]','special')));if(w(s)){if(i&&t.match(/^\d+$/)){return a}s=JSON.stringify(''+t);s.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,'name')):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,'string'))}return s+': '+a}function _(e,n,r){var o=0,t=e.reduce(function(e,n){o++;n.indexOf('\n')>=0&&o++;return e+n.replace(/\u001b\[\d\d?m/g,'').length+1},0);if(t>60){return r[0]+(n===''?'':n+'\n ')+' '+e.join(',\n  ')+' '+r[1]}return r[0]+n+' '+e.join(', ')+' '+r[1]}function g(e){return Array.isArray(e)}r.isArray=g;function j(e){return typeof e==='boolean'}r.isBoolean=j;function b(e){return e===null}r.isNull=b;function E(e){return e==null}r.isNullOrUndefined=E;function y(e){return typeof e==='number'}r.isNumber=y;function v(e){return typeof e==='string'}r.isString=v;function z(e){return typeof e==='symbol'}r.isSymbol=z;function w(e){return e===void 0}r.isUndefined=w;function A(e){return N(e)&&P(e)==='[object RegExp]'}r.isRegExp=A;function N(e){return typeof e==='object'&&e!==null}r.isObject=N;function O(e){return N(e)&&P(e)==='[object Date]'}r.isDate=O;function C(e){return N(e)&&(P(e)==='[object Error]'||e instanceof Error)}r.isError=C;function S(e){return typeof e==='function'}r.isFunction=S;function x(e){return e===null||typeof e==='boolean'||typeof e==='number'||typeof e==='string'||typeof e==='symbol'||typeof e==='undefined'}r.isPrimitive=x;r.isBuffer=e('./support/isBuffer');function P(e){return Object.prototype.toString.call(e)}function I(e){return e<10?'0'+e.toString(10):e.toString(10)}var T=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];function k(){var e=new Date,n=[I(e.getHours()),I(e.getMinutes()),I(e.getSeconds())].join(':');return[e.getDate(),T[e.getMonth()],n].join(' ')}r.log=function(){console.log('%s - %s',k(),r.format.apply(r,arguments))};r.inherits=e('inherits');r._extend=function(e,n){if(!n||!N(n))return e;var r=Object.keys(n),o=r.length;while(o--)e[r[o]]=n[r[o]];return e};function M(e,n){return Object.prototype.hasOwnProperty.call(e,n)}}).call(this,e('_process'),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./support/isBuffer":4,"_process":3,"inherits":2}],"PopJSON":[function(e,n,r){"use strict";let o=e('fs'),t=e('util'),i={'ACC_FIXED':'d','ACC_ERLANG':'d','ACC_PASCAL':'d','AGE_FIXED':'i','AGE_CONST':'i','AGE_GAMMA':'i','AGE_NBINOM':'i','AGE_CUSTOM':'i','NOAGE_CONST':'i'},s={'NO_STEPPER':'0','AGE_STEPPER':'age_stepper','ACC_STEPPER':'acc_stepper'},a={'AGE_FIXED':['age_fixed_pars','age_hazard_calc','age_fixed_haz'],'AGE_CONST':['age_const_pars','age_const_calc','age_const_haz'],'AGE_GAMMA':['age_gamma_pars','age_hazard_calc','age_gamma_haz'],'AGE_NBINOM':['age_nbinom_pars','age_hazard_calc','age_nbinom_haz'],'NOAGE_CONST':['age_const_pars','age_const_calc','age_const_haz']};class u{constructor(){this.header="";this.model="";this.error="";this.json={}}check_ids(e){if(!/^[a-zA-Z][a-zA-Z0-9\_]+$/.test(e)){this.error+="Only numeric and alphanumeric characters and \"_\" are allowed in IDs. Also, IDs should be more than one character and start with an alphanumeric.\nViolating ID is "+e+"\n";return""}if(this.ids.includes(e)){this.error+="IDs should be unique! Please check "+e+"\n";return""}this.ids.push(e);return e}results(){return({"model":this.header+this.model,"error":this.error})}parse_file(e){this.filename=e;let n=o.readFileSync(this.filename);if(!n){this.error+="File not found!\n";return(this.results())}try{this.json=JSON.parse(n)}catch(e){this.error+="JSON parse error!\n";return(this.results())};this.parse();return(this.results())}parse_json(e){try{this.json=JSON.parse(e)}catch(e){this.error+="JSON parse error!\n";return(this.results())};this.parse();return(this.results())}process_json(e){this.json=e;this.parse();return(this.results())}parse(){let e=this;this.ids=[];this.deterministic=this.json.model.deterministic;('environ' in this.json)||(this.json.environ=[]);this.environs=this.json.environ.map(n=>e.check_ids(n.id));if(!('populations' in this.json)){this.json.populations=[];this.error+="Couldn't find any populations!\n";return(this.results())}this.populations=this.json.populations.map(n=>e.check_ids(n.id));this.processes=[];this.json.populations.forEach(n=>'processes' in n?n.processes.forEach(n=>{e.processes.push(e.check_ids(n.id))}):[]);this.processobj={};this.json.populations.forEach(n=>'processes' in n?n.processes.forEach(r=>{e.processobj[r.id]=r,e.processobj[r.id].parent_id=n.id}):{});('parameters' in this.json)||(this.json.parameters=[]);this.parametersv=this.json.parameters.filter(e=>!e.constant).map(n=>e.check_ids(n.id));this.parametersc=this.json.parameters.filter(e=>e.constant).map(e=>e.id);('functions' in this.json)||(this.json.functions=[]);this.functions=Object.keys(this.json.functions);('intermediates' in this.json)||(this.json.intermediates=[]);this.intermediates=this.json.intermediates.map(n=>e.check_ids(n.id));('transformations' in this.json)||(this.json.transformations=[]);this.transformations=this.json.transformations.map(n=>e.check_ids(n.id));('transfers' in this.json)||(this.json.transfers=[]);this.transfers=Array.from(new Set(this.json.transfers.map(n=>n.from in e.processobj?e.processobj[n.from].parent_id:n.from)));this.operations=["abs","min","max","round","poisson","binomial","define","?","&&","||",">=","<=",">","<","==","sqrt","pow","exp","log","log2","log10","indicator","index","size","count","*","+","-","/"];this.funparnames=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];this.funcountid=0;this.header="";this.model="";this.error||(this.handle_repeats(),this.write_model())}handle_repeats(){}write_model(){this.funcountid=0;this.header="";this.model="";this.write_header();this.write_functions();this.write_harvest();this.write_custom();this.write_init();this.write_parnames();this.write_destroy();this.write_sim();this.write_main()}write_header(){let e=this;this.json.model.type=="Population"&&(this.header+="#include <math.h>\n",this.header+="#include \"population.h\"\n",this.header+="\n",this.deterministic?this.json.model.type=="ODE"&&(this.header+="#include <stdlib.h>\n",this.header+="#include \"lsoda.h\"\n",this.header+="\n"):(this.header+="extern gsl_rng *RANDOM;\n",this.header+="\n"));this.header+="#define CHECK(x) (isnan(x) || isinf(x))\n";this.header+="\n";this.numpar=this.json.parameters.filter(e=>!e.constant).length;this.numpop=this.json.populations.length;this.numint_int=this.json.intermediates.length;this.numint_trans=this.json.transformations.length;this.numint=this.numint_int+this.numint_trans;this.numenv=this.environs.length;this.json.model.type=="Population"&&(this.json.populations.length==0?(this.numproc=0,this.numprocpar=0):(this.numproc=1+Math.max(...this.json.populations.map(e=>'processes' in e?e.processes.length:0)),this.numprocpar=Math.max(...this.json.populations.map((e,n)=>{let r=0;if(!('processes' in e))return r;e.processes.forEach(e=>{Array.isArray(e.value)?(r+=e.value.length):(r+=1)});return r}))));this.popart={};this.json.model.type=="Population"&&this.json.populations.forEach(n=>{(n.id in e.popart)||(e.popart[n.id]={}),n.processes.forEach(r=>{e.popart[n.id][r.arbiter]=i[r.arbiter]})});this.header+="#define NumPar "+t.format(this.numpar)+"\n";this.header+="#define NumPop "+t.format(this.numpop)+"\n";this.header+="#define NumInt "+t.format(this.numint)+"\n";this.header+="#define NumEnv "+t.format(this.numenv)+"\n";this.header+="\n";this.json.parameters.filter(e=>!e.constant).forEach((n,r)=>{e.header+="#define "+n.id+" "+t.format(r)+"\n"});this.header+="\n";this.json.model.type=="Population"&&(this.json.populations.forEach((n,r)=>{n.processes.forEach((n,r)=>{e.header+="#define "+n.id+" "+t.format(r)+"\n"})}),this.header+="\n");this.json.parameters.filter(e=>e.constant).forEach(n=>{e.header+="double "+n.id+" = "+t.format(n.value)+";\n"});this.header+="\n";this.header+="double dmin(double a, double b) { return a < b ? a : b; }\n";this.header+="double dmax(double a, double b) { return a > b ? a : b; }\n";this.header+="\n";this.header+="int TIME;\n";this.header+="\n";this.header+="double *model_param;\n";'environ' in this.json&&(this.json.environ.forEach((n,r)=>{e.header+="double *envir_"+n.id+";\n"}),this.header+="\n");'transformations' in this.json&&(this.deterministic?this.json.transformations.map(e=>e.id).forEach(n=>{e.header+="double "+n+";\n"}):this.json.transformations.map(e=>e.id).forEach(n=>{e.header+="unsigned int "+n+";\n"}));'intermediates' in this.json&&(this.json.intermediates.forEach((n,r)=>{e.header+="double "+n.id+";\n"}),this.header+="\n")}write_functions(){let e=this;'functions' in this.json&&(Object.entries(this.json.functions).forEach(([n,r])=>{e.header+="#define "+n+e.parse_value(r)+"\n"}),this.header+="\n")}write_transfer(){if(!('transfers' in this.json))return;let e=this;var n,r;this.json.transfers.forEach(o=>{e.header+="void fun_transfer_"+o.id+"(number *key, number num, void *pop) {\n",e.header+="    number q["+t.format(e.numproc)+"] = {\n",r=e.json.populations.filter(e=>e.id==o.to)[0],r.processes.forEach((t,i)=>{n=e.popart[r.id][t.arbiter],e.header+="        {."+n+"="+e.parse_value(o.value[i],!0)+"},\n"}),e.header+="    };\n",e.header+="    spop2_add(*(population *)pop, q, num);\n",e.header+="}\n",e.header+="\n"})}write_harvest(){if(!('transfers' in this.json))return;let e=this;var n,r;this.json.transfers.forEach(o=>{e.header+="void fun_harvest_"+o.id+"(number *key, number num, number *newkey, double *frac) {\n",r=e.json.populations.filter(e=>e.id==o.to)[0],r.processes.forEach((i,s)=>{n=e.popart[r.id][i.arbiter],e.header+="    newkey["+t.format(s)+"]."+n+"="+e.parse_value(o.value[1][s],!0)+";\n"}),e.header+="    *frac = "+e.parse_value(o.value[0],!0)+";\n",e.header+="}\n",e.header+="\n"})}write_custom(){let e=this;this.json.populations.forEach(n=>{if(!('processes' in n)||n.processes.length==0)return;n.processes.forEach(r=>{'hazard' in r&&(e.header+="double fun_hazard_"+r.id+"_"+n.id+"(hazard hfun, unsigned int d, number q, number k, double theta, const number *key) {\n",e.header+="    double devmn = "+e.parse_value(r.hazard[1],!0)+";\n",e.header+="    double devsd = "+e.parse_value(r.hazard[2],!0)+";\n",e.header+="    hazpar hz = "+a[r.hazard[0]][0]+"(devmn, devsd);\n",e.header+="    double a = "+a[r.hazard[0]][1]+"("+a[r.hazard[0]][2]+", 0, key["+r.id+"], hz.k, hz.theta, key);\n",e.header+="    return a;\n",e.header+="}\n",e.header+="\n"),'hazpar' in r&&r.hazpar&&(e.header+="void fun_hazpar_"+r.id+"_"+n.id+"(const number *key, const number num, double *par) {\n",r.value.forEach((n,r)=>{e.header+="    par["+t.format(r)+"] = "+e.parse_value(n,!0)+";\n"}),e.header+="}\n",e.header+="\n")})})}write_init(){this.model+="void init(int *no, int *np, int *ni, int *ne, int *st) {\n";this.json.model.type=="Population"&&(this.deterministic||(this.model+="    spop2_random_init();\n",this.model+="\n"),'istep' in this.json.model.parameters&&(this.model+="    spop2_set_eps("+t.format(this.json.model.parameters.istep)+");\n",this.model+="\n"));this.model+="    *no = NumPop;\n";this.model+="    *np = NumPar;\n";this.model+="    *ni = NumInt;\n";this.model+="    *ne = NumEnv;\n";this.model+="    *st = "+(this.deterministic?"0":"1")+";\n";this.model+="}\n";this.model+="\n"}write_parnames(){let e=this;this.model+="void parnames(char **names, double *param, double *parmin, double *parmax) {\n";this.model+="    char temp[NumPop+NumPar+NumInt+NumEnv][256] = {\n";this.numpop>0&&(this.model+="        \""+this.json.populations.map(e=>e.id).join("\", \"")+"\",\n");this.numpar>0&&(this.model+="        \""+this.json.parameters.filter(e=>!e.constant).map(e=>e.id).join("\", \"")+"\",\n");this.numint_int>0&&(this.model+="        \""+this.json.intermediates.map(e=>e.id).join("\", \"")+"\",\n");this.numint_trans>0&&(this.model+="        \""+this.json.transformations.map(e=>e.id).join("\", \"")+"\",\n");this.numenv>0&&(this.model+="        \""+this.environs.join("\", \"")+"\",\n");this.model+="    };\n";this.model+="\n";this.model+="    int i;\n";this.model+="    for (i=0; i<(NumPop+NumPar+NumInt+NumEnv); i++)\n";this.model+="        names[i] = strdup(temp[i]);\n";this.model+="\n";this.json.parameters.filter(e=>!e.constant).forEach((n,r)=>{e.model+="    param["+n.id+"] = "+t.format('value' in n?this.parse_value(n.value):0)+";\n",e.model+="    parmin["+n.id+"] = "+t.format('min' in n?this.parse_value(n.min):('value' in n?this.parse_value(n.value):0))+";\n",e.model+="    parmax["+n.id+"] = "+t.format('max' in n?this.parse_value(n.max):('value' in n?this.parse_value(n.value):0))+";\n"});this.model+="}\n";this.model+="\n"}write_destroy(){this.model+="void destroy(void) {\n";this.json.model.type=="Population"&&!this.deterministic&&(this.model+="    spop2_random_destroy();\n");this.model+="}\n";this.model+="\n"}write_out(e,n=!0){let r=this;this.deterministic?this.json.populations.forEach((n,o)=>{r.model+="    ".repeat(e)+"ret["+t.format(o)+"] = size_"+n.id+".d;\n"+"    ".repeat(e)+"if (CHECK(ret["+t.format(o)+"])) {goto endall;};\n"}):this.json.populations.forEach((n,o)=>{r.model+="    ".repeat(e)+"ret["+t.format(o)+"] = (double)(size_"+n.id+".i);\n"+"    ".repeat(e)+"if (CHECK(ret["+t.format(o)+"])) {goto endall;};\n"});this.model+="\n";this.model+="    ".repeat(e)+"ret += "+(t.format(this.json.populations.length))+";\n";this.model+="\n";n&&('intermediates' in this.json&&(this.json.intermediates.forEach((n,o)=>{r.model+="    ".repeat(e)+"iret["+t.format(o)+"] = "+n.id+";\n"+"    ".repeat(e)+"if (CHECK(iret["+t.format(o)+"])) {goto endall;};\n"}),this.model+="\n"),'transformations' in this.json&&(this.json.transformations.forEach((n,o)=>{r.model+="    ".repeat(e)+"iret["+t.format(this.json.intermediates.length+o)+"] = "+n.id+";\n"+"    ".repeat(e)+"if (CHECK(iret["+t.format(o)+"])) {goto endall;};\n"}),this.model+="\n"),'intermediates' in this.json&&(this.model+="    ".repeat(e)+"iret += "+(t.format(this.json.intermediates.length+this.json.transformations.length))+";\n"),this.model+="\n")}write_sim(){let e,n=this,r=this.deterministic?'DETERMINISTIC':'STOCHASTIC';this.model+="void sim(int tf, int rep, double *envir, double *pr, double *y0, const char *file0, const char *file1, double *ret, double *iret, int *success) {\n";this.model+="\n";this.model+="    TIME = 0;\n";this.model+="\n";this.model+="    model_param = pr;\n";'environ' in this.json&&(this.model+="\n",this.json.environ.forEach((e,r)=>{n.model+="    envir_"+e.id+" = envir + 1; envir += (int)round(*envir) + 1;\n"}),this.model+="\n");this.json.model.type=="Population"&&(this.json.populations.forEach(e=>{n.model+="    population "+t.format(e.id)+";\n"}),this.model+="\n");this.json.model.type=="Population"&&(this.model+="    number num = numZERO;\n",this.model+="    char arbiters["+t.format(this.numproc)+"];\n",this.model+="    number key["+t.format(this.numproc)+"];\n",this.json.populations.forEach((e,r)=>{n.model+="    number size_"+e.id+";\n"}),this.json.populations.forEach((e,r)=>{if(e.processes.length==0)return;n.model+="    number completed_"+e.id+"["+t.format(n.numproc)+"];\n"}),this.json.populations.forEach((e,r)=>{n.transfers&&n.transfers.includes(e.id)&&n.populations.includes(e.id)&&(n.model+="    population popdone_"+e.id+"["+t.format(n.numproc)+"];\n")}),'transformations' in this.json&&(this.deterministic?this.json.transformations.map(e=>e.id).forEach(e=>{n.model+="    "+e+" = 0.0;\n"}):this.json.transformations.map(e=>e.id).forEach(e=>{n.model+="    "+e+" = 0;\n"})),this.model+="    double par["+t.format(this.numprocpar)+"];\n",this.model+="\n",this.model+="    FILE *file;\n",this.model+="    number *buff = 0;\n",this.model+="    unsigned int buffsz = 0;\n",this.model+="    if (file0 && file0[0]!=' ') {\n",this.model+="        file = fopen(file0,\"rb\");\n",this.model+="        if (!file) {\n",this.model+="            *success = 0;\n",this.model+="            goto endall;\n",this.model+="        }\n",this.model+="        rewind(file);\n",this.model+="    }\n",this.model+="\n",this.model+="    if (file0 && file0[0]!=' ') {\n",this.json.populations.forEach((r,o)=>{n.model+="        fread(&buffsz, sizeof(unsigned int), 1, file);\n";n.model+="        buff = (number *)malloc(buffsz);\n";n.model+="        fread(buff, buffsz, 1, file);\n";n.model+="        "+r.id+" = spop2_loadstate(buff);\n";n.model+="\n";if(n.transfers&&n.transfers.includes(r.id)&&n.populations.includes(r.id)){for(e=0;e<n.numproc;e++)n.model+="        popdone_"+r.id+"["+t.format(e)+"] = spop2_loadstate_empty(buff);\n"}n.model+="\n";n.model+="        free(buff);\n";n.model+="\n"}),this.model+="    } else {\n",this.json.populations.forEach((o,i)=>{for(e=0;e<n.numproc;e++)n.model+="        arbiters["+t.format(e)+"] = "+(e<o.processes.length?o.processes[e].arbiter:"STOP")+";\n",n.model+="        key["+t.format(e)+"] = numZERO;\n";n.model+="        "+o.id+" = spop2_init(arbiters, "+r+");\n";for(e=0;e<n.numproc;e++){if(e<o.processes.length&&'stepper' in o.processes[e]){if(!(o.processes[e].stepper in s)){n.error+="Stepper not defined. Please choose one of these: "+Object.keys(s).join(", ")+"\n";break}n.model+="        "+o.id+"->arbiters["+t.format(e)+"]->fun_step = "+s[o.processes[e].stepper]+";\n"}if(e<o.processes.length){if('hazard' in o.processes[e]){if(!(o.processes[e].hazard[0] in a)){n.error+="Hazard not defined. Please choose one of these: "+Object.keys(a).join(", ")+"\n";break}n.model+="        "+o.id+"->arbiters["+t.format(e)+"]->fun_calc = fun_hazard_"+o.processes[e].id+"_"+o.id+";\n"}'hazpar' in o.processes[e]&&(n.model+="        "+o.id+"->arbiters["+t.format(e)+"]->fun_q_par = fun_hazpar_"+o.processes[e].id+"_"+o.id+";\n")}}n.model+="        if (y0["+t.format(i)+"]) { num."+("i",n.deterministic?"d":"i")+" = y0["+t.format(i)+"]; spop2_add("+o.id+", key, num); }\n";n.model+="\n";if(n.transfers&&n.transfers.includes(o.id)&&n.populations.includes(o.id)){for(e=0;e<n.numproc;e++)n.model+="        popdone_"+o.id+"["+t.format(e)+"] = spop2_init(arbiters, "+r+");\n"}this.model+="\n"}),n.model+="    }\n",this.model+="\n",this.model+="    if (file0 && file0[0]!=' ') {\n",this.model+="        fclose(file);\n",this.model+="    }\n");'intermediates' in this.json&&(this.json.intermediates.forEach((e,r)=>{n.model+="    "+e.id+" = 0.0;\n"}),this.model+="\n");this.json.populations.forEach((e,r)=>{n.model+="    size_"+e.id+" = spop2_size("+e.id+");\n"});this.model+="\n";this.write_out(1,!1);this.model+="    for (TIME=1; TIME<tf; TIME++) {\n";'intermediates' in this.json&&(this.json.intermediates.forEach(e=>{n.model+="        "+e.id+" = "+n.parse_value(e.value)+";\n"}),this.model+="\n");this.model+="        if (rep >= 0) {\n";this.json.model.type=="Population"&&(this.json.populations.forEach((r,o)=>{if(r.processes.length==0)return;let i=[];r.processes.forEach(e=>{Array.isArray(e.value)?e.value.forEach(n=>i.push('hazpar' in e&&e.hazpar?"0.0":n)):i.push('hazpar' in e&&e.hazpar?"0.0":e.value)});for(e=0;e<n.numprocpar;e++)n.model+="                par["+t.format(e)+"] = "+(i.length?n.parse_value(i.shift()):"0.0")+";\n";n.model+="                spop2_step("+r.id+", par, &size_"+r.id+", completed_"+r.id+", "+(n.transfers.includes(r.id)&&n.populations.includes(r.id)?"popdone_"+r.id:"0")+");\n";n.model+="\n"}),'transformations' in this.json&&(this.json.transformations.forEach(r=>{n.model+="                "+r.id+" = "+n.parse_value(r.value)+";\n";n.model+="\n";if('to' in r){for(e=0;e<n.numproc;e++)n.model+="                key["+t.format(e)+"] = numZERO;\n";n.model+="                num"+(n.deterministic?".d":".i")+" = "+r.id+";\n";n.model+="                spop2_add("+r.to+", key, num);\n";n.model+="\n";n.deterministic?(n.model+="                size_"+r.to+".d += "+r.id+";\n"):(n.model+="                size_"+r.to+".i += "+r.id+";\n")}}),n.model+="\n"),'transfers' in this.json&&(this.json.transfers.forEach(e=>{if(e.from in n.processobj)n.model+="                spop2_harvest(popdone_"+n.processobj[e.from].parent_id+"["+e.from+"], "+e.to+", fun_harvest_"+e.id+");\n";else if(n.populations.includes(e.from))n.model+="                spop2_harvest("+e.from+", "+e.to+", fun_harvest_"+e.id+");\n";else{n.error+="Error in defining the source population for transfer: "+e.from+"\n";return""}}),n.model+="\n",this.transfers.forEach(r=>{for(e=0;e<n.numproc;e++)n.model+="                spop2_empty(&popdone_"+r+"["+t.format(e)+"]);\n";n.model+="\n"}),Array.from(new Set(this.json.transfers.map(e=>e.to))).forEach(e=>{n.model+="                size_"+e+" = spop2_size("+e+");\n"}),n.model+="\n"),n.model+="        }\n",n.model+="\n",this.write_out(2,!0));this.model+="    }\n";this.model+="\n";this.model+="  endall:\n";this.model+="\n";this.model+="    *success = TIME;\n";this.model+="\n";this.model+="    if (file1 && file1[0]!=' ') {\n";this.model+="        file = fopen(file1,\"wb\");\n";this.model+="        if (!file) {\n";this.model+="            *success = 0;\n";this.model+="        } else {\n";this.model+="            rewind(file);\n";this.model+="\n";this.json.model.type=="Population"&&this.json.populations.forEach(e=>{n.model+="            buffsz = spop2_buffsize("+e.id+");\n",n.model+="            buff = spop2_savestate("+e.id+");\n",n.model+="            fwrite(&buffsz, sizeof(unsigned int), 1, file);\n",n.model+="            fwrite(buff, buffsz, 1, file);\n",n.model+="            free(buff);\n",n.model+="\n"});this.model+="            fclose(file);\n";this.model+="        }\n";this.model+="    }\n";this.model+="\n";this.json.model.type=="Population"&&(this.json.populations.forEach(r=>{n.model+="    spop2_free(&"+r.id+");\n";if(n.transfers&&n.transfers.includes(r.id)&&n.populations.includes(r.id)){for(e=0;e<n.numproc;e++)n.model+="    spop2_free(&(popdone_"+r.id+"["+t.format(e)+"]));\n"}}),this.model+="\n");this.model+="}\n";this.model+="\n"}write_main(){this.model+="int main(int argc, char *argv[]) {\n";this.model+="    return 0;\n";this.model+="}\n";this.model+="\n"}write_funcount(e,n){this.header+="char "+e+"(number *key) {\n";this.header+="    return "+n+";\n";this.header+="}\n";this.header+="\n"}parse_value(e,n=!1){let r=this;if(Array.isArray(e)){let o=this.parse_value(e[0],n=n);if(o=="define"){if(!(e[1].every(e=>r.funparnames.includes(e)))){this.error+="Error in function definition\nYou are allowed to use these as parameter names:\n"+r.funparnames+"\nERROR: "+o+" : "+e+"\n";return""}let t=this.parse_value(e[2],n=n);return"("+e[1].join(",")+") ("+t+")"}else if(o=="count"){let o=e[1];if(!r.json.populations.filter(e=>e.id==o)[0]){this.error+="Error in count request\nHere is the correct usage:\n[\"count\", \"population name\", [condition]]\n";return""}this.funcountid+=1;let t="fun_count_"+o+"_"+this.funcountid,i=this.parse_value(e[2],n=!0);this.write_funcount(t,i);return"spop2_count("+o+", "+t+")"+(this.deterministic?".d":".i")}else if(this.environs.includes(o)){let r=this.parse_value(e[1],n=n);return"envir_"+o+"["+r+"]"}else{let t=e.slice(1).map(e=>r.parse_value(e,n=n));if(o=="size"){return"size_"+t[0]+(this.deterministic?".d":".i")}else if(o=="index"){return t[0]+"["+t[1]+"]"}else if(o=="round"){return o+"("+t.join(", ")+")"}else if(o=="min"){return"dmin("+t.join(", ")+")"}else if(o=="max"){return"dmax("+t.join(", ")+")"}else if(o=="abs"){return"fabs("+t.join(", ")+")"}else if(this.functions.includes(o)||o=="exp"||o=="log"||o=="log2"||o=="log10"||o=="pow"||o=="sqrt"){return o+"("+t.join(", ")+")"}else if(o=="binomial"){return"(unsigned int)gsl_ran_binomial(RANDOM, "+t[0]+", "+t[1]+")"}else if(o=="poisson"){return"(unsigned int)gsl_ran_poisson(RANDOM, "+t[0]+")"}else if(o=="*"){return"("+t.join(" * ")+")"}else if(o=="+"){return"("+t.join(" + ")+")"}else if(o=="-"){return"("+t.join(" - ")+")"}else if(o=="/"){return"("+t.join(" / ")+")"}else if(o=="?"){return"(("+t[0]+") ? ("+t[1]+") : ("+t[2]+"))"}else if(o=="&&"){return"("+t.join(" && ")+")"}else if(o=="||"){return"("+t.join(" || ")+")"}else if(o=="indicator"){return this.deterministic?"("+t[0]+" ? 1.0 : 0.0)":"("+t[0]+" ? 1 : 0)"}else if(o=="=="){return"("+t[0]+" == "+t[1]+")"}else if(o==">"){return"("+t[0]+" > "+t[1]+")"}else if(o=="<"){return"("+t[0]+" < "+t[1]+")"}else if(o==">="){return"("+t[0]+" >= "+t[1]+")"}else if(o=="<="){return"("+t[0]+" <= "+t[1]+")"}else{this.error+="Unknown keyword in equation\nERROR: "+o+" : "+e+"\n";return""}}}else{if(typeof e==='string'||e instanceof String){if(e in this.processobj){let r=this.processobj[e].parent_id;if(n){return"key["+e+"]."+this.popart[r][this.processobj[e].arbiter]}return"completed_"+r+"["+e+"]"+(this.deterministic?".d":".i")}else if(this.populations.includes(e)){if(n){return e}return"size_"+e+(this.deterministic?".d":".i")}else if(this.environs.includes(e)){return e}else if(this.parametersv.includes(e)){return"model_param["+e+"]"}else if(this.parametersc.includes(e)){return e}else if(this.functions.includes(e)){return e}else if(this.intermediates.includes(e)){return e}else if(this.transformations.includes(e)){return e}else if(this.operations.includes(e)){return e}else if(this.funparnames.includes(e)){return"("+e+")"}else if(e=="TIME"){return"TIME"}else if(e=="TIME_1"){return"(TIME-1)"}else if(!isNaN(parseFloat(e))){return e}else if(!isNaN(parseInt(e))){return e}else{this.error+="Unknown reference to a user defined keyword\nERROR: "+e+"\n";return""}}else if(typeof e==='number'){return e.toString()}else{this.error+="ERROR: Invalid value encountered: "+e+"\n";return""}}}}r.PopJSON=u},{"fs":1,"util":5}]},{},["PopJSON"])
